<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Modern Camera App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000;
            --surface-color: rgba(25, 25, 25, 0.7);
            --border-color: rgba(255, 255, 255, 0.2);
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0a0;
            --accent-primary: #9370DB; /* Medium Purple */
            --accent-secondary: #FF00FF; /* Magenta */
            --danger-color: #ff3b30;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        body {
            font-family: var(--font-family);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .camera-app-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.3s, filter 0.3s;
        }
        
        #video-preview.mirrored {
            transform: scaleX(-1);
        }
        
        #countdown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            font-size: 10rem; color: rgba(255, 255, 255, 0.9); font-weight: 600;
            -webkit-text-stroke: 2px black; text-shadow: 0 0 20px black;
            z-index: 10;
        }
        
        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: none;
            z-index: 5;
        }
        
        .grid-overlay.visible {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
        }
        
        .grid-overlay > div {
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .controls-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
            z-index: 20;
        }

        .top-bar, .bottom-bar {
            width: 100%;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            pointer-events: auto;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }
        .bottom-bar {
            background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
            justify-content: space-around;
        }
        .top-bar {
            justify-content: flex-end;
            gap: 1rem;
        }

        .icon-button {
            background: rgba(25, 25, 25, 0.5);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            padding: 0;
        }
        .icon-button.active, .icon-button:hover:not(:disabled) {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(147, 112, 219, 0.4);
        }
        .icon-button:disabled { opacity: 0.4; cursor: not-allowed; }
        .icon-button svg { width: 24px; height: 24px; stroke-width: 2; stroke: currentColor; fill: none; }
        
        #capture-photo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #fff;
            border: 4px solid var(--bg-color);
            box-shadow: 0 0 0 4px #fff;
            transition: transform 0.2s;
            animation: pulse-capture 2s infinite;
        }
        @keyframes pulse-capture {
            0% { box-shadow: 0 0 0 4px #fff; }
            70% { box-shadow: 0 0 0 8px rgba(255,255,255,0); }
            100% { box-shadow: 0 0 0 4px rgba(255,255,255,0); }
        }
        #capture-photo:hover:not(:disabled) { transform: scale(1.05); }
        
        #record-video {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            background: transparent;
            border: 3px solid var(--accent-secondary);
            color: var(--accent-secondary);
        }
        #record-video.recording { background-color: var(--accent-secondary); }

        #gallery-thumbnail-btn {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            border: 2px solid #fff;
            overflow: hidden;
            background-color: rgba(25,25,25,0.5);
        }
        #gallery-thumbnail-btn img { width: 100%; height: 100%; object-fit: cover; }
        
        #error-message {
            position: absolute; top: 60px; left: 50%;
            transform: translateX(-50%);
            padding: 1rem; border-radius: 8px;
            text-align: center; display: none; word-wrap: break-word;
            color: #fff; background-color: rgba(255, 59, 48, 0.8);
            z-index: 100;
        }
        
        #qr-result {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            padding: 1rem; border-radius: 8px;
            text-align: center; display: none; word-wrap: break-word;
            color: var(--text-color); background-color: rgba(147, 112, 219, 0.8);
            z-index: 100;
        }
        #qr-result a { color: #fff; text-decoration: underline; }
        
        #status-indicator {
            position: absolute; top: 1rem; left: 1rem;
            background-color: var(--danger-color); color: white;
            padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9em;
            display: none; align-items: center; animation: pulse 1.5s infinite;
            z-index: 10;
        }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* --- Modal Styles --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal.visible { opacity: 1; visibility: visible; }

        .modal-content {
            background: var(--surface-color);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal.visible .modal-content { transform: scale(1); }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; flex-shrink: 0;
        }
        .modal-header h2 { margin: 0; }
        #modal-close-btn, #gallery-close-btn { background: none; border: none; }
        
        .modal-body { overflow-y: auto; }

        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: var(--text-secondary-color); }
        select, input[type="text"] {
            width: 100%; padding: 0.75rem; border-radius: 8px;
            border: 1px solid var(--border-color); background-color: rgba(0,0,0,0.2);
            color: var(--text-color); font-family: var(--font-family); font-size: 1rem;
        }
        select:focus, input[type="text"]:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(147, 112, 219, 0.2);
        }
        
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: rgba(0,0,0,0.3); border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px;
            border-radius: 50%; background: var(--accent-primary);
            cursor: pointer; margin-top: -7px; 
            box-shadow: 0 0 8px rgba(147, 112, 219, 0.5);
        }

        .control-group { margin-bottom: 1.25rem; }
        .control-group:last-child { margin-bottom: 0; }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .button-grid button, .control-group button {
             background: rgba(255, 255, 255, 0.1);
             border: 1px solid var(--border-color);
        }
        .button-grid button:hover, .control-group button:hover {
             background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
             color: #fff;
             border-color: transparent;
        }


        /* --- Gallery Modal Specifics --- */
        #gallery-modal .modal-content { max-width: 90vw; }
        .gallery-body { display: flex; gap: 1.5rem; flex-grow: 1; min-height: 0; }

        .gallery-preview-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #gallery-preview-area {
            width: 100%;
            flex-grow: 1;
            background-color: rgba(0,0,0,0.2);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary-color); overflow: hidden;
        }
        #gallery-preview-img { width: 100%; height: 100%; object-fit: contain; display: none; }

        #gallery-grid-container {
            flex: 1; min-width: 200px;
            display: flex; flex-direction: column;
        }
        #gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 1rem; overflow-y: auto;
        }
        .thumbnail-container { position: relative; }
        .thumbnail {
            width: 100%; aspect-ratio: 1/1; object-fit: cover;
            border-radius: 8px; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .thumbnail:hover { border-color: var(--text-secondary-color); }
        .thumbnail.featured { border-color: var(--accent-primary); box-shadow: 0 0 12px rgba(147, 112, 219, 0.5); }
        .delete-btn {
            position: absolute; top: 4px; right: 4px;
            background-color: rgba(255, 59, 48, 0.8);
            border: none; border-radius: 50%;
            width: 24px; height: 24px; padding: 0;
            opacity: 0; transition: opacity 0.2s;
            color: #fff;
        }
        .thumbnail-container:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background-color: var(--danger-color); }

    </style>
</head>
<body>

    <div class="camera-app-container">
        <video id="video-preview" autoplay playsinline></video>
        <canvas id="canvas-capture" style="display:none;"></canvas>

        <!-- Overlays -->
        <div id="grid-overlay" class="grid-overlay">
            <div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div>
        </div>
        <div id="countdown-overlay"></div>
        <div id="status-indicator" class="status-indicator">REC</div>
        <div id="error-message"></div>
        <div id="qr-result"></div>

        <div class="controls-overlay">
            <div class="top-bar">
                <button id="toggle-grid" class="icon-button" title="Toggle Grid"><svg viewBox="0 0 24 24"><path d="M3 3H21M3 9H21M3 15H21M3 21V3M9 21V3M15 21V3M21 21V3" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <button id="mirror-video" class="icon-button" title="Mirror Video"><svg viewBox="0 0 24 24"><path d="M10.0002 19L10 16M10.0002 5L10 8M10.0002 12L3 12M10.0002 12L17 12M6 8L3 12L6 16M14 16L17 12L14 8M21 3V21" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <button id="toggle-torch" class="icon-button" title="Toggle Torch" style="display: none;"><svg viewBox="0 0 24 24"><path d="M9.17157 14.8284L14.8284 9.17157M12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21Z" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <button id="toggle-qr-scan" class="icon-button" title="Scan QR Code"><svg viewBox="0 0 24 24"><path d="M4 4H8V8H4V4Z" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 16H8V20H4V16Z" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 4H20V8H16V4Z" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 16H20V20H16V16Z" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 4V8" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6H14" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 16V20" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 18H14" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 10H6" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 10H20" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 12V14" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 10H16" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 12V14" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <button id="settings-btn" class="icon-button" title="Settings"><svg viewBox="0 0 24 24"><path d="M4 12H20M4 6H20M4 18H20" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            </div>
            <div class="bottom-bar">
                <button id="gallery-thumbnail-btn"><img id="gallery-thumbnail-img" alt="Last photo thumbnail"></button>
                <button id="capture-photo" title="Capture Photo"></button>
                <button id="record-video" title="Record Video"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="currentColor"></circle></svg></button>
                 <button id="switch-camera" class="icon-button" title="Switch Camera"><svg viewBox="0 0 24 24"><path d="M1 12C1 14.1565 1.77678 16.2239 3.14923 17.7495M1 12C1 9.84346 1.77678 7.77611 3.14923 6.25052M1 12H2M23 12C23 14.1565 22.2232 16.2239 20.8508 17.7495M23 12C23 9.84346 22.2232 7.77611 20.8508 6.25052M23 12H22M12 23C14.1565 23 16.2239 22.2232 17.7495 20.8508M12 23C9.84346 23 7.77611 22.2232 6.25052 20.8508M12 23V22M12 1C14.1565 1 16.2239 1.77678 17.7495 3.14923M12 1C9.84346 1 7.77611 1.77678 6.25052 3.14923M12 1V2M9 16.5V13.5M9 13.5H12M9 13.5L13 9.5M15 7.5V10.5M15 10.5H12M15 10.5L11 14.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings & Tools</h2>
                <button id="modal-close-btn" class="icon-button"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6L18 18" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            </div>
            <div class="modal-body">
                 <div class="control-group">
                    <label for="camera-select">Input Device</label>
                    <select id="camera-select"></select>
                </div>
                 <div class="control-group">
                    <label for="resolution-select">Resolution</label>
                    <select id="resolution-select">
                        <option value="640x480">640 x 480</option>
                        <option value="1280x720" selected>1280 x 720 (HD)</option>
                        <option value="1920x1080">1920 x 1080 (Full HD)</option>
                        <option value="3840x2160">3840 x 2160 (4K)</option>
                    </select>
                </div>
                 <div class="control-group">
                    <label for="timer-select">Timer</label>
                    <select id="timer-select">
                        <option value="0">Off</option>
                        <option value="3">3s</option>
                        <option value="5">5s</option>
                        <option value="10">10s</option>
                    </select>
                 </div>
                 <div class="control-group">
                    <label for="filter-select">Filter</label>
                    <select id="filter-select">
                        <option value="none">None</option>
                        <option value="grayscale(100%)">Grayscale</option>
                        <option value="sepia(100%)">Sepia</option>
                        <option value="invert(100%)">Invert</option>
                        <option value="contrast(200%)">Contrast</option>
                        <option value="sepia(60%) contrast(110%) brightness(90%)">Vintage</option>
                    </select>
                </div>
                <div class="control-group" id="zoom-control" style="display: none;">
                    <label for="zoom-slider">Zoom</label>
                    <input type="range" id="zoom-slider" min="1" max="10" step="0.1">
                </div>
                <div class="control-group" id="exposure-control" style="display: none;">
                    <label for="exposure-slider">Exposure</label>
                    <input type="range" id="exposure-slider" min="-2" max="2" step="0.1">
                </div>
                <div class="control-group">
                    <label>Actions</label>
                    <button id="burst-mode" title="Burst Mode"><span>Burst Mode</span></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gallery Modal -->
    <div id="gallery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gallery</h2>
                <button id="gallery-close-btn" class="icon-button"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6L18 18" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            </div>
            <div class="modal-body gallery-body">
                <div class="gallery-preview-container">
                    <div id="gallery-preview-area">
                        <span id="gallery-preview-text">Select a photo</span>
                        <img id="gallery-preview-img" alt="Selected photo">
                    </div>
                    <div class="control-group">
                        <label for="filename-input">Filename</label>
                        <input type="text" id="filename-input" value="photo-capture">
                    </div>
                    <div class="control-group">
                        <label for="format-select">Format</label>
                        <select id="format-select">
                            <option value="png">PNG</option>
                            <option value="jpeg">JPEG</option>
                        </select>
                    </div>
                    <div class="button-grid">
                        <button id="download-photo" disabled>Download</button>
                        <button id="upload-photo" disabled>Upload</button>
                    </div>
                </div>
                <div id="gallery-grid-container">
                    <div id="gallery-grid"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('canvas-capture');
        const captureBtn = document.getElementById('capture-photo');
        const recordBtn = document.getElementById('record-video');
        const errorMessage = document.getElementById('error-message');
        const statusIndicator = document.getElementById('status-indicator');
        const mirrorBtn = document.getElementById('mirror-video');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const toggleGridBtn = document.getElementById('toggle-grid');
        const gridOverlay = document.getElementById('grid-overlay');
        const toggleQrScanBtn = document.getElementById('toggle-qr-scan');
        const qrResult = document.getElementById('qr-result');
        const switchCameraBtn = document.getElementById('switch-camera');
        const toggleTorchBtn = document.getElementById('toggle-torch');
        const settingsBtn = document.getElementById('settings-btn');
        const galleryThumbnailBtn = document.getElementById('gallery-thumbnail-btn');
        const galleryThumbnailImg = document.getElementById('gallery-thumbnail-img');
        let qrCanvas = document.createElement('canvas'); 

        // --- Modal DOM Elements ---
        const settingsModal = document.getElementById('settings-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const galleryModal = document.getElementById('gallery-modal');
        const galleryCloseBtn = document.getElementById('gallery-close-btn');
        const galleryGrid = document.getElementById('gallery-grid');
        const galleryPreviewImg = document.getElementById('gallery-preview-img');
        const galleryPreviewText = document.getElementById('gallery-preview-text');
        
        // --- Modal Controls ---
        const cameraSelect = document.getElementById('camera-select');
        const resolutionSelect = document.getElementById('resolution-select');
        const timerSelect = document.getElementById('timer-select');
        const filterSelect = document.getElementById('filter-select');
        const zoomControl = document.getElementById('zoom-control');
        const zoomSlider = document.getElementById('zoom-slider');
        const exposureControl = document.getElementById('exposure-control');
        const exposureSlider = document.getElementById('exposure-slider');
        const burstModeBtn = document.getElementById('burst-mode');
        const downloadBtn = document.getElementById('download-photo');
        const uploadBtn = document.getElementById('upload-photo');
        const filenameInput = document.getElementById('filename-input');
        const formatSelect = document.getElementById('format-select');

        // --- State Variables ---
        let currentStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let capturedPhotos = [];
        let featuredPhotoId = null;
        let countdownInterval = null;
        let isScanningQr = false;
        let qrAnimationId = null;
        let videoDevices = [];
        let currentDeviceIndex = 0;

        // --- Core Camera Functions ---
        async function getCameraDevices() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                cameraSelect.innerHTML = '';
                if (videoDevices.length === 0) {
                    showError("No camera devices found.");
                    return;
                }

                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                switchCameraBtn.disabled = videoDevices.length <= 1;
                startCamera(videoDevices[currentDeviceIndex].deviceId);
            } catch (err) {
                handleError(err);
            }
        }

        async function startCamera(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const [width, height] = resolutionSelect.value.split('x').map(Number);
            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    width: { ideal: width },
                    height: { ideal: height }
                }
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                errorMessage.style.display = 'none';
                updateAdvancedControls();
            } catch (err) {
                handleError(err);
            }
        }

        function updateAdvancedControls() {
            if (!currentStream) return;
            const track = currentStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            if (capabilities.zoom) {
                zoomControl.style.display = 'block';
                zoomSlider.min = capabilities.zoom.min;
                zoomSlider.max = capabilities.zoom.max;
                zoomSlider.step = capabilities.zoom.step;
                zoomSlider.value = track.getSettings().zoom || capabilities.zoom.min;
            } else { zoomControl.style.display = 'none'; }

            if (capabilities.exposureCompensation) {
                exposureControl.style.display = 'block';
                exposureSlider.min = capabilities.exposureCompensation.min;
                exposureSlider.max = capabilities.exposureCompensation.max;
                exposureSlider.step = capabilities.exposureCompensation.step;
                exposureSlider.value = track.getSettings().exposureCompensation || 0;
            } else { exposureControl.style.display = 'none'; }
            
            toggleTorchBtn.style.display = capabilities.torch ? '' : 'none';
        }
        
        // --- Event Handlers ---
        cameraSelect.addEventListener('change', () => {
             const selectedDeviceId = cameraSelect.value;
             currentDeviceIndex = videoDevices.findIndex(d => d.deviceId === selectedDeviceId);
             startCamera(selectedDeviceId);
        });
        
        resolutionSelect.addEventListener('change', () => startCamera(videoDevices[currentDeviceIndex].deviceId));

        switchCameraBtn.addEventListener('click', () => {
            if (videoDevices.length > 1) {
                currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
                cameraSelect.value = videoDevices[currentDeviceIndex].deviceId;
                startCamera(videoDevices[currentDeviceIndex].deviceId);
            }
        });

        function takePhoto() {
             if (!currentStream) {
                showError("Camera stream not available.");
                return;
            }
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            if (video.classList.contains('mirrored')) {
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
            }
            context.filter = video.style.filter;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const dataUrl = canvas.toDataURL('image/png');
            const newPhoto = { id: Date.now(), dataUrl };
            capturedPhotos.push(newPhoto);
            updateGalleryThumbnail(newPhoto.dataUrl);
            setFeaturedPhoto(newPhoto.id);
        }

        captureBtn.addEventListener('click', () => {
            const timerDuration = parseInt(timerSelect.value, 10);
            if (timerDuration > 0) {
                if (countdownInterval) return;
                
                let count = timerDuration;
                countdownOverlay.textContent = count;
                countdownOverlay.style.display = 'flex';
                toggleControls(true);

                countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownOverlay.textContent = count;
                    } else {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                        countdownOverlay.style.display = 'none';
                        takePhoto();
                        toggleControls(false);
                    }
                }, 1000);
            } else {
                takePhoto();
            }
        });
        
        burstModeBtn.addEventListener('click', () => {
            settingsModal.classList.remove('visible'); // Close modal first
            let burstCount = 0;
            const maxBursts = 5;
            toggleControls(true);
            const burstInterval = setInterval(() => {
                if (burstCount < maxBursts) {
                    takePhoto();
                    burstCount++;
                } else {
                    clearInterval(burstInterval);
                    toggleControls(false);
                }
            }, 200);
        });
        
        filterSelect.addEventListener('change', (e) => video.style.filter = e.target.value);
        mirrorBtn.addEventListener('click', () => {
            video.classList.toggle('mirrored');
            mirrorBtn.classList.toggle('active');
        });
        recordBtn.addEventListener('click', () => (mediaRecorder && mediaRecorder.state === 'recording') ? stopRecording() : startRecording());
        toggleGridBtn.addEventListener('click', () => {
            gridOverlay.classList.toggle('visible');
            toggleGridBtn.classList.toggle('active');
        });

        toggleQrScanBtn.addEventListener('click', () => {
            if (!isScanningQr) {
                isScanningQr = true;
                toggleQrScanBtn.classList.add('active');
                qrResult.style.display = 'none';
                scanQrCode();
            } else {
                stopQrScan();
            }
        });

        zoomSlider.addEventListener('input', async () => {
            try {
                const track = currentStream.getVideoTracks()[0];
                await track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
            } catch (err) { console.error('Zoom failed:', err); }
        });
        exposureSlider.addEventListener('input', async () => {
            try {
                const track = currentStream.getVideoTracks()[0];
                await track.applyConstraints({ advanced: [{ exposureCompensation: exposureSlider.value }] });
            } catch (err) { console.error('Exposure failed:', err); }
        });
        toggleTorchBtn.addEventListener('click', async () => {
             try {
                const track = currentStream.getVideoTracks()[0];
                const isTorchOn = track.getSettings().torch;
                await track.applyConstraints({ advanced: [{ torch: !isTorchOn }] });
                toggleTorchBtn.classList.toggle('active', !isTorchOn);
            } catch (err) { console.error('Torch failed:', err); }
        });

        downloadBtn.addEventListener('click', () => {
            if (!featuredPhotoId) { showError("No photo selected to download."); return; }
            const photo = capturedPhotos.find(p => p.id === featuredPhotoId);
            if (!photo) return;
            
            const format = formatSelect.value;
            const mimeType = `image/${format}`;
            const filename = `${filenameInput.value || 'photo-capture'}.${format}`;

            const img = new Image();
            img.onload = () => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width; tempCanvas.height = img.height;
                tempCanvas.getContext('2d').drawImage(img, 0, 0);
                
                const link = document.createElement('a');
                link.download = filename;
                link.href = tempCanvas.toDataURL(mimeType, 0.9);
                link.click();
            };
            img.src = photo.dataUrl;
        });

        uploadBtn.addEventListener('click', async () => {
            if (!featuredPhotoId) { showError("No photo selected to upload."); return; }
            const photo = capturedPhotos.find(p => p.id === featuredPhotoId);
            if (!photo) return;
            
            try {
                const response = await fetch(photo.dataUrl);
                const blob = await response.blob();
                const formData = new FormData();
                formData.append('photo', blob, `${filenameInput.value || 'photo-capture'}.png`);

                uploadBtn.disabled = true;
                
                // NOTE: This requires the Node.js server from the README to be running on your local machine.
                const uploadResponse = await fetch('http://localhost:3000/upload', { method: 'POST', body: formData });

                if (!uploadResponse.ok) throw new Error('Server returned an error.');
                
                const result = await uploadResponse.json();
                showError(`Upload successful! File saved as: ${result.filename}`);

            } catch (err) {
                showError('Upload failed. Ensure server is running.');
                console.error("Upload Error:", err);
            } finally {
                if(featuredPhotoId) uploadBtn.disabled = false;
            }
        });

        function scanQrCode() {
            if (!currentStream || !isScanningQr) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                qrCanvas.height = video.videoHeight; qrCanvas.width = video.videoWidth;
                const ctx = qrCanvas.getContext('2d');
                ctx.drawImage(video, 0, 0, qrCanvas.width, qrCanvas.height);
                const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code && code.data) {
                    stopQrScan();
                    qrResult.innerHTML = 'QR Code: ';
                    try {
                        new URL(code.data);
                        qrResult.innerHTML += `<a href="${code.data}" target="_blank" rel="noopener noreferrer">${code.data}</a>`;
                    } catch (_) {
                        qrResult.textContent += code.data;
                    }
                    qrResult.style.display = 'block';
                    setTimeout(() => qrResult.style.display = 'none', 5000);
                }
            }
            qrAnimationId = requestAnimationFrame(scanQrCode);
        }
        
        function stopQrScan() {
            isScanningQr = false;
            cancelAnimationFrame(qrAnimationId);
            toggleQrScanBtn.classList.remove('active');
        }

        function startRecording() {
            if (!currentStream) { showError("Camera stream not available."); return; }
            recordedChunks = [];
            try { mediaRecorder = new MediaRecorder(currentStream, { mimeType: 'video/webm; codecs=vp9' });
            } catch (e) { showError('Recording format not supported.'); return; }

            mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) recordedChunks.push(event.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.style.display = 'none';
                a.href = url; a.download = `video-${Date.now()}.webm`;
                document.body.appendChild(a); a.click();
                URL.revokeObjectURL(url); document.body.removeChild(a);
            };

            mediaRecorder.start();
            recordBtn.classList.add('recording');
            recordBtn.innerHTML = `<svg viewBox="0 0 24 24"><rect x="8" y="8" width="8" height="8" rx="1.5" fill="currentColor"/></svg>`;
            statusIndicator.style.display = 'flex';
            toggleControls(true, true);
        }

        function stopRecording() {
            mediaRecorder.stop();
            recordBtn.classList.remove('recording');
            recordBtn.innerHTML = `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="currentColor"></circle></svg>`;
            statusIndicator.style.display = 'none';
            toggleControls(false, false);
        }
        
        function updateGalleryThumbnail(dataUrl) {
            galleryThumbnailImg.src = dataUrl;
        }

        function updateGallery() {
            galleryGrid.innerHTML = '';
            capturedPhotos.forEach((photo) => {
                const container = document.createElement('div'); container.classList.add('thumbnail-container');
                const img = document.createElement('img');
                img.src = photo.dataUrl; img.classList.add('thumbnail');
                if (photo.id === featuredPhotoId) img.classList.add('featured');
                img.addEventListener('click', () => setFeaturedPhoto(photo.id));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.title = 'Delete photo';
                deleteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6L18 18" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deletePhoto(photo.id); });
                
                container.appendChild(img); container.appendChild(deleteBtn); galleryGrid.appendChild(container);
            });
            if (capturedPhotos.length === 0) galleryGrid.innerHTML = `<p style="color:var(--text-secondary-color); text-align:center; width:100%; grid-column: 1 / -1;">Gallery is empty</p>`;
        }
        
        function deletePhoto(id) {
            capturedPhotos = capturedPhotos.filter(p => p.id !== id);
            
            if (capturedPhotos.length > 0) {
                 updateGalleryThumbnail(capturedPhotos[capturedPhotos.length - 1].dataUrl);
            } else {
                updateGalleryThumbnail(''); // clear thumbnail
            }

            if (id === featuredPhotoId) {
                const newFeaturedId = capturedPhotos.length > 0 ? capturedPhotos[capturedPhotos.length - 1].id : null;
                setFeaturedPhoto(newFeaturedId);
            }
            updateGallery();
        }

        function setFeaturedPhoto(id) {
            featuredPhotoId = id;
            const hasFeatured = !!featuredPhotoId;
            
            if (hasFeatured) {
                const photo = capturedPhotos.find(p => p.id === id);
                galleryPreviewImg.src = photo ? photo.dataUrl : '';
                galleryPreviewImg.style.display = 'block'; galleryPreviewText.style.display = 'none';
            } else {
                 galleryPreviewImg.style.display = 'none'; galleryPreviewText.style.display = 'block';
            }
            downloadBtn.disabled = !hasFeatured; 
            uploadBtn.disabled = !hasFeatured;
            updateGallery();
        }
        
        function toggleControls(disabled, isRecording = false) {
            captureBtn.disabled = disabled;
            switchCameraBtn.disabled = disabled;
            burstModeBtn.disabled = disabled;
            cameraSelect.disabled = disabled; // These are in the modal but good to disable
            resolutionSelect.disabled = disabled;
            
            // disable top bar buttons
            document.querySelectorAll('.top-bar .icon-button').forEach(btn => btn.disabled = disabled);
            
            if(!isRecording) recordBtn.disabled = disabled;
        }

        function showError(message) {
            errorMessage.textContent = message; errorMessage.style.display = 'block';
            setTimeout(() => { errorMessage.style.display = 'none'; }, 5000);
        }

        function handleError(err) {
            console.error("Camera Error:", err);
            let message = "An unexpected error occurred.";
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') message = "Camera access was denied. Please allow camera permissions and refresh.";
            else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') message = "No camera was found. Please connect a camera.";
            else if (err.name === 'OverconstrainedError') message = `The selected resolution is not supported by your device. Try a lower one.`;
            showError(message);
        }
        
        // --- Modal Toggles ---
        settingsBtn.addEventListener('click', () => settingsModal.classList.add('visible'));
        modalCloseBtn.addEventListener('click', () => settingsModal.classList.remove('visible'));
        settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) settingsModal.classList.remove('visible'); });

        galleryThumbnailBtn.addEventListener('click', () => {
            if(capturedPhotos.length > 0) {
                 updateGallery();
                 galleryModal.classList.add('visible');
            }
        });
        galleryCloseBtn.addEventListener('click', () => galleryModal.classList.remove('visible'));
        galleryModal.addEventListener('click', (e) => { if(e.target === galleryModal) galleryModal.classList.remove('visible'); });


        // --- Initial Load ---
        getCameraDevices();
    });
    </script>
</body>
</html>


